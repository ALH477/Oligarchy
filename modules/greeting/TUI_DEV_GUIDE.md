# TUI Development Guide

## Architecture

The NixOS Welcome TUI is built using [Textual](https://textual.textualize.io/), a modern Python framework for building terminal user interfaces.

### Components

```
tui/
├── welcome_tui.py    # Main TUI application
└── setup.py          # Python package definition
```

### Main Classes

- **WelcomeApp** - Main application class
- **MainScreen** - Primary screen with all panels
- **WelcomeBanner** - ASCII art header
- **SystemInfo** - Live system information panel
- **QuickLinks** - Links table widget
- **TipsPanel** - Random tips display
- **PackageSearch** - Package management help

## Testing the TUI Locally

### Option 1: Demo Script (No Installation)

```bash
# Install dependencies
pip install textual

# Run demo
python3 demo.py
```

### Option 2: Install as Package

```bash
cd tui
pip install -e .
welcome-tui
```

### Option 3: Using Nix

```bash
# Build the TUI package
nix build .#welcome-tui

# Run it
./result/bin/welcome-tui
```

## Customizing the TUI

### Adding New Panels

1. Create a new widget class:

```python
class MyCustomPanel(Static):
    def compose(self) -> ComposeResult:
        yield Label("[b cyan]My Panel[/b cyan]")
        yield Label("Custom content here")
```

2. Add to MainScreen:

```python
class MainScreen(Screen):
    def compose(self) -> ComposeResult:
        # ... existing code ...
        yield MyCustomPanel()
```

### Modifying System Info

Edit the `SystemInfo` class in `welcome_tui.py`:

```python
class SystemInfo(Static):
    def compose(self) -> ComposeResult:
        # Add custom system metrics
        info_table.add_row("Custom Metric", "Value")
```

### Adding Keyboard Shortcuts

Add to the `BINDINGS` list in `MainScreen`:

```python
BINDINGS = [
    Binding("q", "quit", "Quit"),
    Binding("r", "refresh", "Refresh"),
    Binding("h", "help", "Help"),  # New binding
]

def action_help(self) -> None:
    """Show help screen"""
    # Your help implementation
```

### Changing Colors and Styling

Modify the `CSS` string in `WelcomeApp`:

```python
CSS = """
#ascii-art {
    color: $success;        # Change color
    text-style: bold;
    background: $panel;     # Add background
}

DataTable {
    background: $surface;
    border: solid $primary;
}
"""
```

Available color variables:
- `$primary`, `$secondary`, `$accent`
- `$success`, `$warning`, `$error`
- `$surface`, `$panel`, `$background`
- Custom colors: `#FF0000` (hex)

### Adding Animation

```python
from textual.widgets import LoadingIndicator

class AnimatedPanel(Static):
    def compose(self) -> ComposeResult:
        yield LoadingIndicator()
        yield Label("Loading...")
```

## Configuration Integration

The TUI reads configuration from a JSON file passed as argument:

```python
welcome-tui /path/to/config.json
```

Config format:
```json
{
  "links": [
    ["Name", "URL"],
    ["Another", "https://example.com"]
  ],
  "tips": [
    "Tip 1",
    "Tip 2"
  ],
  "welcome_message": "Custom message",
  "ascii_art": "Your ASCII art"
}
```

This is automatically generated by the NixOS module from your `configuration.nix`.

## Advanced Features

### Adding Real-time Updates

Use Textual's reactive system:

```python
from textual.reactive import reactive

class LiveSystemInfo(Static):
    cpu_usage = reactive(0.0)
    
    def watch_cpu_usage(self, value: float) -> None:
        """Called when cpu_usage changes"""
        self.update(f"CPU: {value}%")
    
    def on_mount(self) -> None:
        self.set_interval(1, self.update_cpu)
    
    def update_cpu(self) -> None:
        # Update CPU usage every second
        self.cpu_usage = get_cpu_usage()
```

### Adding Modal Dialogs

```python
from textual.screen import ModalScreen

class ConfirmDialog(ModalScreen):
    def compose(self) -> ComposeResult:
        yield Label("Are you sure?")
        yield Button("Yes")
        yield Button("No")
```

### Adding Multiple Screens

```python
class SettingsScreen(Screen):
    def compose(self) -> ComposeResult:
        yield Header()
        yield Label("Settings")
        yield Footer()

class WelcomeApp(App):
    def on_mount(self) -> None:
        self.install_screen(SettingsScreen(), name="settings")
    
    def action_settings(self) -> None:
        self.push_screen("settings")
```

## Debugging

### Enable Textual DevTools

```bash
# Terminal 1: Run app in dev mode
textual run --dev welcome_tui.py

# Terminal 2: Open console
textual console
```

### Print Debugging

```python
from textual import log

log("Debug message")
log.info("Info message")
log.warning("Warning")
log.error("Error")
```

### Log File

Textual logs are written to:
```
~/.textual/welcome_tui.log
```

## Performance Tips

1. **Lazy Loading**: Load data only when needed
2. **Pagination**: For large datasets, use pagination
3. **Caching**: Cache expensive operations
4. **Async**: Use async for I/O operations

```python
async def get_system_info(self) -> dict:
    """Async system info fetch"""
    return await asyncio.gather(
        get_cpu_info(),
        get_memory_info(),
        get_disk_info()
    )
```

## Building & Packaging

### Local Build

```bash
cd tui
python -m build
```

### Nix Build

```bash
nix build .#welcome-tui
```

### Install from Source

```bash
cd tui
pip install .
```

## Contributing

When adding new features:

1. Follow Textual best practices
2. Update `BINDINGS` for new actions
3. Add CSS styling for new widgets
4. Update this guide
5. Test on actual NixOS system
6. Consider performance impact

## Resources

- [Textual Documentation](https://textual.textualize.io/)
- [Textual Widget Gallery](https://textual.textualize.io/widget_gallery/)
- [Textual GitHub](https://github.com/Textualize/textual)
- [Rich (Text Formatting)](https://rich.readthedocs.io/)

## Common Issues

### TUI not launching
```bash
# Check if textual is installed
python3 -c "import textual"

# Check if welcome-tui is in PATH
which welcome-tui
```

### Colors not working
```bash
# Check terminal support
echo $TERM

# Try with different TERM
TERM=xterm-256color welcome-tui
```

### Config not loading
```bash
# Check config file exists
cat /nix/store/.../welcome-tui-config.json

# Test with explicit config
welcome-tui /path/to/config.json
```
