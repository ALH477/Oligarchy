# Flake Architecture Documentation

Internal documentation for the Oligarchy Plymouth Theme flake structure.

## Flake Structure

```
oligarchy-theme/
├── flake.nix           # Main flake definition
├── flake.lock          # Pinned dependencies
├── module.nix          # NixOS module implementation
└── package.nix         # Package derivation
```

## Component Breakdown

### flake.nix

**Purpose**: Main flake entry point  
**Exports**:
- `packages.${system}.oligarchy-plymouth-theme` - The theme package
- `nixosModules.oligarchy-plymouth` - The NixOS module
- `devShells.default` - Development environment
- `formatter` - Code formatter (nixpkgs-fmt)

**Key features**:
- Multi-system support (x86_64-linux, aarch64-linux)
- Helper function `forAllSystems` for DRY code
- Development shell with Plymouth and ImageMagick

**Dependencies**:
```nix
inputs = {
  nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
};
```

### module.nix

**Purpose**: NixOS module with declarative options  
**Location**: Imported by flake.nix

**Options provided**:
```nix
boot.plymouth.oligarchy = {
  enable            # boolean - Enable theme
  wallpaper         # null or path - Wallpaper image
  overlayOpacity    # float (0.0-1.0) - Overlay darkness
  quiet             # boolean - Quiet boot
  consoleLogLevel   # int (0-7) - Console verbosity
};
```

**Implementation details**:
- Uses `lib.mkEnableOption` for boolean options
- Uses `lib.mkOption` for typed options
- Provides activation script for wallpaper copying
- Sets up Plymouth configuration automatically
- Includes helpful warnings for advanced features

**Activation Script**:
```nix
system.activationScripts.oligarchyPlymouthWallpaper = ''
  # Copies wallpaper to theme directory at activation
'';
```

### package.nix

**Purpose**: Nix package derivation for the theme  
**Type**: `stdenv.mkDerivation`

**What it does**:
1. Creates output directory structure
2. Copies theme files (oligarchy.plymouth, oligarchy.script)
3. Optionally copies wallpaper.jpg if present
4. Updates paths in oligarchy.plymouth to match install location
5. Sets proper metadata

**Install paths**:
```
$out/share/plymouth/themes/oligarchy/
├── oligarchy.plymouth
├── oligarchy.script
└── wallpaper.jpg (if present)
```

**Version**: 2.0.0

### flake.lock

**Purpose**: Pin exact versions of dependencies  
**Format**: JSON with hashes and revisions

**Generated by**: `nix flake update`

**Contains**:
- Exact nixpkgs revision
- Commit hash for reproducibility
- Metadata (lastModified, narHash)

## Outputs Structure

```nix
outputs = {
  packages.x86_64-linux.oligarchy-plymouth-theme = <derivation>
  packages.x86_64-linux.default = <same>
  
  packages.aarch64-linux.oligarchy-plymouth-theme = <derivation>
  packages.aarch64-linux.default = <same>
  
  nixosModules.oligarchy-plymouth = <module>
  nixosModules.default = <same>
  
  devShells.x86_64-linux.default = <shell>
  devShells.aarch64-linux.default = <shell>
  
  formatter.x86_64-linux = nixpkgs-fmt
  formatter.aarch64-linux = nixpkgs-fmt
}
```

## Usage Flow

### As End User

1. **Add flake input**:
   ```nix
   inputs.oligarchy-plymouth.url = "path:./oligarchy-theme";
   ```

2. **Import module**:
   ```nix
   imports = [ oligarchy-plymouth.nixosModules.default ];
   ```

3. **Configure**:
   ```nix
   boot.plymouth.oligarchy.enable = true;
   ```

4. **Build**:
   ```bash
   sudo nixos-rebuild switch --flake .#
   ```

### What Happens

1. Flake evaluates → loads module.nix
2. Module is imported into NixOS configuration
3. User sets `boot.plymouth.oligarchy.enable = true`
4. Module:
   - Enables `boot.plymouth.enable`
   - Sets `boot.plymouth.theme = "oligarchy"`
   - Adds theme package to `boot.plymouth.themePackages`
   - Optionally applies quiet boot settings
   - Sets up wallpaper activation script if configured
5. Package builds → installs files to /nix/store
6. Activation script runs → copies wallpaper if present
7. Plymouth uses theme at next boot

## Module Integration Points

### With NixOS

```nix
config = mkIf cfg.enable {
  boot.plymouth = {
    enable = true;
    theme = "oligarchy";
  };
  
  boot.kernelParams = mkIf cfg.quiet [ "quiet" ];
  boot.consoleLogLevel = cfg.consoleLogLevel;
};
```

### Package Injection

```nix
config = lib.mkIf config.boot.plymouth.oligarchy.enable {
  boot.plymouth.themePackages = [ 
    self.packages.${pkgs.system}.oligarchy-plymouth-theme 
  ];
};
```

## Development

### Entering Dev Shell

```bash
nix develop
# or
nix-shell
```

**Provides**:
- Plymouth (for testing)
- ImageMagick (for wallpaper creation)
- Custom shell hook with helpful commands

### Testing the Package

```bash
# Build package
nix build

# Check result
ls -la result/share/plymouth/themes/oligarchy/

# Install to profile
nix profile install .#
```

### Updating Dependencies

```bash
# Update all inputs
nix flake update

# Update specific input
nix flake lock --update-input nixpkgs
```

### Checking Flake

```bash
# Validate flake
nix flake check

# Show flake info
nix flake show

# Show metadata
nix flake metadata
```

## Type Safety

Module options are type-checked:

```nix
wallpaper = mkOption {
  type = types.nullOr types.path;
  # ...
};

overlayOpacity = mkOption {
  type = types.float;
  # Will error if not 0.0-1.0
};
```

## Error Handling

### Invalid Configuration

```nix
boot.plymouth.oligarchy.overlayOpacity = 2.0;
# Error: value is out of range
```

### Missing Wallpaper

```nix
boot.plymouth.oligarchy.wallpaper = ./nonexistent.jpg;
# Error: file does not exist
```

### Wrong Type

```nix
boot.plymouth.oligarchy.enable = "yes";
# Error: expected boolean, got string
```

## Best Practices

### For Users

✅ Use the module options  
✅ Keep wallpapers under 2MB  
✅ Use `quiet = true` for clean boot  
❌ Don't modify package.nix directly  
❌ Don't set overlayOpacity > 1.0  

### For Developers

✅ Test on multiple systems  
✅ Update flake.lock regularly  
✅ Document new options  
✅ Add helpful warnings  
✅ Validate inputs  

## Future Enhancements

Potential improvements:

1. **Dynamic Overlay Opacity**:
   - Generate script with custom opacity
   - Currently warns user to edit manually

2. **Theme Variants**:
   - Light mode option
   - Minimal mode option
   - Multiple color schemes

3. **Animation Customization**:
   - Module options for spinner speed
   - Configurable dot count
   - Custom colors

4. **Multiple Wallpapers**:
   - Random selection at boot
   - Time-based switching

5. **Home Manager Integration**:
   - Per-user wallpaper preferences
   - User-specific themes

## Testing Matrix

### Systems Tested

- [x] x86_64-linux (Intel/AMD 64-bit)
- [x] aarch64-linux (ARM 64-bit)
- [ ] i686-linux (32-bit, unsupported)

### NixOS Versions

- [x] 23.11 (Stable)
- [x] 24.05 (Stable)
- [x] Unstable

### Plymouth Versions

- [x] Plymouth 22.02
- [x] Plymouth 24.004

## Troubleshooting

### Common Issues

**"flake.nix not found"**:
- Ensure you're in the theme directory
- Check file permissions

**"Module not available"**:
- Verify flake input is correct
- Run `nix flake update`

**"Package fails to build"**:
- Check oligarchy.script syntax
- Verify all files present

**"Theme not applied"**:
- Check Plymouth is enabled
- Verify theme in themePackages
- Run `sudo nixos-rebuild switch`

## References

- [Nix Flakes Manual](https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html)
- [NixOS Module System](https://nixos.org/manual/nixos/stable/index.html#sec-writing-modules)
- [Plymouth Documentation](https://www.freedesktop.org/wiki/Software/Plymouth/)

## Version History

- **v3.0** - Flake module implementation
- **v2.1** - Wallpaper support
- **v2.0** - DeMoD palette
- **v1.0** - Initial release